<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML><HEAD><TITLE>3 The C Part</TITLE><LINK href="ozdoc.css" rel="stylesheet" type="text/css"></HEAD><BODY><TABLE align="center" border="0" cellpadding="6" cellspacing="6" class="nav"><TR bgcolor="#DDDDDD"><TD><A href="node2.html#sec.foreignex">&lt;&lt; Prev</A></TD><TD><A href="index.html">- Up -</A></TD><TD><A href="node4.html#chapter.unixdll">Next &gt;&gt;</A></TD></TR></TABLE><DIV id="chapter.cpart"><H1><A name="chapter.cpart">3 The C Part</A></H1><P><A href="node2.html#getenvc">Program&nbsp;2.1</A> shows a first attempt to provide access to the <CODE>getenv</CODE> C library function as explained above. In the following we will go through it in detail and successively improve it.</P><P>Every C program that will be linked to Oz must include the header file <CODE>mozart.h</CODE> (line 1 in <A href="node2.html#getenvc">Program&nbsp;2.1</A>), which is located in the <CODE>include</CODE> subdirectory of the Oz installation directory. It contains the definition of the data structures and functions used to interface C to Oz. All these data structures start with <CODE>OZ_</CODE> such that they will not clash with the user's name space.</P><P>To declare a C function that can be used from Oz you have to enclose its declaration into the macros <CODE>OZ_BI_define(</CODE><I>name</I><CODE>,</CODE><I>inarity</I><CODE>,</CODE><I>outarity</I><CODE>)</CODE> <A name="label3"></A> and <CODE>OZ_BI_end</CODE> <A name="label5"></A>. The following code fragment declares a C-function <CODE>BIgetenv</CODE> <A name="label7"></A> for inclusion into Oz, which has one input an one output argument:</P><P></P><BLOCKQUOTE class="code"><CODE><SPAN class="functionname">OZ_BI_define</SPAN>(BIgetenv,1,1)<BR>{<BR>&nbsp;&nbsp;...<BR>}&nbsp;<SPAN class="variablename">OZ_BI_end</SPAN></CODE></BLOCKQUOTE><P></P><P>Oz represents data like strings, integers, floats, etc. different than C. For this reason <CODE>mozart.h</CODE> provides type testing functions and routines to convert from the C into the Oz representation and vice versa. All Oz values are summarized in one abstract C data type called <CODE>OZ_Term</CODE> <A name="label9"></A>.</P><P>To signal whether the call to a C function was successful or not it must return a value of type <CODE>OZ_Return</CODE><A name="label11"></A>, which may be <CODE>OZ_FAILED</CODE><A name="label13"></A> (in which case failure will occur), <CODE>OZ_ENTAILED</CODE><A name="label15"></A> to signal successful completion. <CODE>OZ_Return</CODE> also contains several other values, which are not visible to the user. They are only used for internal purposes, for example to handle suspension or raising exceptions.</P><DIV class="danger"><P class="margin"><IMG align="top" alt="Danger" src="danger.gif"></P><P>It is important that your C function returns one of the above values. Not returning a value will inevitably crash the executing Oz engine!</P></DIV><P>In line 5 we use the macro <CODE>OZ_declareAtom(n,name)</CODE>: it checks whether the <CODE>n</CODE>-th input argument is an atom and declares a new C++ variable of type <CODE><SPAN class="type">char</SPAN>*</CODE> with name <CODE>name</CODE>. So line 5 declares <CODE>envVarName</CODE> which holds the C++ string representation of the first and only input argument.</P><P>Values that can be passed as input arguments can of course be logic variables! Do not confuse this with output arguments: Output arguments are handled only after the C function returns! </P><P>In line 7 we declare a C++ variable <CODE>envValue</CODE> which will temporarily hold the return value of <CODE>BIgetenv</CODE>.</P><P>In lines 9--11 of <A href="node2.html#getenvc">Program&nbsp;2.1</A> we check whether an environment variable of the requested name exists and return <CODE>OZ_FAILED</CODE> if not.</P><P>Line 19 loads the result into the output argument of <CODE>BIgetenv</CODE> using the macro <CODE>OZ_RETURN_ATOM</CODE>: it converts its argument to an Oz atom assigns the first output register to that value and leaves the function with <CODE>OZ_ENTAILED</CODE> signalling that the call to <CODE>BIgetenv</CODE> was success full.</P><P>Lines 16--23 in <A href="node2.html#getenvc">Program&nbsp;2.1</A> are needed for the linking step and will be explained in <A href="node4.html#sec.foreignlink">Section&nbsp;4.3</A>. </P></DIV><TABLE align="center" border="0" cellpadding="6" cellspacing="6" class="nav"><TR bgcolor="#DDDDDD"><TD><A href="node2.html#sec.foreignex">&lt;&lt; Prev</A></TD><TD><A href="index.html">- Up -</A></TD><TD><A href="node4.html#chapter.unixdll">Next &gt;&gt;</A></TD></TR></TABLE><HR><ADDRESS><A href="http://www.ps.uni-sb.de/~mehl/">Michael&nbsp;Mehl</A>, <A href="http://www.ps.uni-sb.de/~tmueller/">Tobias&nbsp;Müller</A>, <A href="http://www.ps.uni-sb.de/~schulte/">Christian&nbsp;Schulte</A> and&nbsp;<A href="http://www.ps.uni-sb.de/~scheidhr/">Ralf&nbsp;Scheidhauer</A><BR><SPAN class="version">Version 1.4.0 (20080702)</SPAN></ADDRESS></BODY></HTML>
